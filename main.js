/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var $=Object.defineProperty;var Le=Object.getOwnPropertyDescriptor;var Me=Object.getOwnPropertyNames;var Fe=Object.prototype.hasOwnProperty;var Ve=(t,e,r)=>e in t?$(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var je=(t,e)=>{for(var r in e)$(t,r,{get:e[r],enumerable:!0})},Be=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Me(e))!Fe.call(t,o)&&o!==r&&$(t,o,{get:()=>e[o],enumerable:!(s=Le(e,o))||s.enumerable});return t};var qe=t=>Be($({},"__esModule",{value:!0}),t);var p=(t,e,r)=>(Ve(t,typeof e!="symbol"?e+"":e,r),r);var ft={};je(ft,{default:()=>Q});module.exports=qe(ft);var $e=require("obsidian");var f=require("obsidian");function S(t){if(t instanceof Error)return t.message;if(typeof t=="string")return t;try{return JSON.stringify(t)}catch(e){return String(t)}}var Se={siteUrl:"",adminApiKey:"",rememberKey:!0},N=class extends f.PluginSettingTab{constructor(r,s){super(r,s);p(this,"plugin");this.plugin=s}display(){let r=this.containerEl;r.empty(),r.createEl("h2",{text:"Ghost Publisher Settings"}),new f.Setting(r).setName("Ghost Site URL").setDesc("Example: https://your-blog.ghost.io").addText(s=>s.setPlaceholder("https://...").setValue(this.plugin.settings.siteUrl).onChange(async o=>{this.plugin.settings.siteUrl=o.replace(/\/$/,""),await this.plugin.saveSettings()})),new f.Setting(r).setName("Admin API Key").setDesc("Retrieved from Ghost Integrations page.").addText(s=>{s.inputEl.type="password",s.setPlaceholder("ID:SECRET").setValue(this.plugin.settings.adminApiKey).onChange(async o=>{this.plugin.settings.adminApiKey=o,this.plugin.settings.rememberKey&&await this.plugin.saveSettings()})}),new f.Setting(r).setName("Remember key").setDesc("If disabled, the key is only stored in memory for the session.").addToggle(s=>s.setValue(this.plugin.settings.rememberKey).onChange(async o=>{this.plugin.settings.rememberKey=o,await this.plugin.saveSettings()})),new f.Setting(r).setName("Test Connection").setDesc("Verify that your URL and API Key are valid.").addButton(s=>s.setButtonText("Test Connection").onClick(async()=>{s.setDisabled(!0),s.setButtonText("Testing...");try{await this.plugin.ghostClient.testConnection()?new f.Notice("Ghost Connection Successful!"):new f.Notice("Ghost Connection Failed. Check console for details.")}catch(o){new f.Notice(`Error: ${S(o)}`)}finally{s.setDisabled(!1),s.setButtonText("Test Connection")}}))}};var Je=require("obsidian");var P=crypto,L=t=>t instanceof CryptoKey;var y=new TextEncoder,W=new TextDecoder,xt=2**32;function xe(...t){let e=t.reduce((o,{length:n})=>o+n,0),r=new Uint8Array(e),s=0;for(let o of t)r.set(o,s),s+=o.length;return r}var ze=t=>{let e=t;typeof e=="string"&&(e=y.encode(e));let r=32768,s=[];for(let o=0;o<e.length;o+=r)s.push(String.fromCharCode.apply(null,e.subarray(o,o+r)));return btoa(s.join(""))},M=t=>ze(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),Xe=t=>{let e=atob(t),r=new Uint8Array(e.length);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return r},F=t=>{let e=t;e instanceof Uint8Array&&(e=W.decode(e)),e=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return Xe(e)}catch(r){throw new TypeError("The input to be decoded is not correctly encoded.")}};var l=class extends Error{constructor(e,r){var s;super(e,r),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,(s=Error.captureStackTrace)==null||s.call(Error,this,this.constructor)}};l.code="ERR_JOSE_GENERIC";var ee=class extends l{constructor(e,r,s="unspecified",o="unspecified"){super(e,{cause:{claim:s,reason:o,payload:r}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=s,this.reason=o,this.payload=r}};ee.code="ERR_JWT_CLAIM_VALIDATION_FAILED";var te=class extends l{constructor(e,r,s="unspecified",o="unspecified"){super(e,{cause:{claim:s,reason:o,payload:r}}),this.code="ERR_JWT_EXPIRED",this.claim=s,this.reason=o,this.payload=r}};te.code="ERR_JWT_EXPIRED";var re=class extends l{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}};re.code="ERR_JOSE_ALG_NOT_ALLOWED";var d=class extends l{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}};d.code="ERR_JOSE_NOT_SUPPORTED";var se=class extends l{constructor(e="decryption operation failed",r){super(e,r),this.code="ERR_JWE_DECRYPTION_FAILED"}};se.code="ERR_JWE_DECRYPTION_FAILED";var oe=class extends l{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}};oe.code="ERR_JWE_INVALID";var w=class extends l{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}};w.code="ERR_JWS_INVALID";var D=class extends l{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}};D.code="ERR_JWT_INVALID";var ie=class extends l{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}};ie.code="ERR_JWK_INVALID";var ne=class extends l{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}};ne.code="ERR_JWKS_INVALID";var ae=class extends l{constructor(e="no applicable key found in the JSON Web Key Set",r){super(e,r),this.code="ERR_JWKS_NO_MATCHING_KEY"}};ae.code="ERR_JWKS_NO_MATCHING_KEY";var ce=class extends l{constructor(e="multiple matching keys found in the JSON Web Key Set",r){super(e,r),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}};ce.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";var le=class extends l{constructor(e="request timed out",r){super(e,r),this.code="ERR_JWKS_TIMEOUT"}};le.code="ERR_JWKS_TIMEOUT";var pe=class extends l{constructor(e="signature verification failed",r){super(e,r),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}};pe.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";function m(t,e="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${e} must be ${t}`)}function H(t,e){return t.name===e}function he(t){return parseInt(t.name.slice(4),10)}function Ye(t){switch(t){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function Ze(t,e){if(e.length&&!e.some(r=>t.usages.includes(r))){let r="CryptoKey does not support this operation, its usages must include ";if(e.length>2){let s=e.pop();r+=`one of ${e.join(", ")}, or ${s}.`}else e.length===2?r+=`one of ${e[0]} or ${e[1]}.`:r+=`${e[0]}.`;throw new TypeError(r)}}function _e(t,e,...r){switch(e){case"HS256":case"HS384":case"HS512":{if(!H(t.algorithm,"HMAC"))throw m("HMAC");let s=parseInt(e.slice(2),10);if(he(t.algorithm.hash)!==s)throw m(`SHA-${s}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!H(t.algorithm,"RSASSA-PKCS1-v1_5"))throw m("RSASSA-PKCS1-v1_5");let s=parseInt(e.slice(2),10);if(he(t.algorithm.hash)!==s)throw m(`SHA-${s}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!H(t.algorithm,"RSA-PSS"))throw m("RSA-PSS");let s=parseInt(e.slice(2),10);if(he(t.algorithm.hash)!==s)throw m(`SHA-${s}`,"algorithm.hash");break}case"EdDSA":{if(t.algorithm.name!=="Ed25519"&&t.algorithm.name!=="Ed448")throw m("Ed25519 or Ed448");break}case"Ed25519":{if(!H(t.algorithm,"Ed25519"))throw m("Ed25519");break}case"ES256":case"ES384":case"ES512":{if(!H(t.algorithm,"ECDSA"))throw m("ECDSA");let s=Ye(e);if(t.algorithm.namedCurve!==s)throw m(s,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}Ze(t,r)}function Ae(t,e,...r){var s;if(r=r.filter(Boolean),r.length>2){let o=r.pop();t+=`one of type ${r.join(", ")}, or ${o}.`}else r.length===2?t+=`one of type ${r[0]} or ${r[1]}.`:t+=`of type ${r[0]}.`;return e==null?t+=` Received ${e}`:typeof e=="function"&&e.name?t+=` Received function ${e.name}`:typeof e=="object"&&e!=null&&(s=e.constructor)!=null&&s.name&&(t+=` Received an instance of ${e.constructor.name}`),t}var ue=(t,...e)=>Ae("Key must be ",t,...e);function de(t,e,...r){return Ae(`Key for the ${t} algorithm must be `,e,...r)}var fe=t=>L(t)?!0:(t==null?void 0:t[Symbol.toStringTag])==="KeyObject",C=["CryptoKey"];var Qe=(...t)=>{let e=t.filter(Boolean);if(e.length===0||e.length===1)return!0;let r;for(let s of e){let o=Object.keys(s);if(!r||r.size===0){r=new Set(o);continue}for(let n of o){if(r.has(n))return!1;r.add(n)}}return!0},Pe=Qe;function et(t){return typeof t=="object"&&t!==null}function k(t){if(!et(t)||Object.prototype.toString.call(t)!=="[object Object]")return!1;if(Object.getPrototypeOf(t)===null)return!0;let e=t;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}var Ce=(t,e)=>{if(t.startsWith("RS")||t.startsWith("PS")){let{modulusLength:r}=e.algorithm;if(typeof r!="number"||r<2048)throw new TypeError(`${t} requires key modulusLength to be 2048 bits or larger`)}};function x(t){return k(t)&&typeof t.kty=="string"}function Te(t){return t.kty!=="oct"&&typeof t.d=="string"}function Re(t){return t.kty!=="oct"&&typeof t.d=="undefined"}function Ke(t){return x(t)&&t.kty==="oct"&&typeof t.k=="string"}function rt(t){let e,r;switch(t.kty){case"RSA":{switch(t.alg){case"PS256":case"PS384":case"PS512":e={name:"RSA-PSS",hash:`SHA-${t.alg.slice(-3)}`},r=t.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":e={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${t.alg.slice(-3)}`},r=t.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":e={name:"RSA-OAEP",hash:`SHA-${parseInt(t.alg.slice(-3),10)||1}`},r=t.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new d('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(t.alg){case"ES256":e={name:"ECDSA",namedCurve:"P-256"},r=t.d?["sign"]:["verify"];break;case"ES384":e={name:"ECDSA",namedCurve:"P-384"},r=t.d?["sign"]:["verify"];break;case"ES512":e={name:"ECDSA",namedCurve:"P-521"},r=t.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":e={name:"ECDH",namedCurve:t.crv},r=t.d?["deriveBits"]:[];break;default:throw new d('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(t.alg){case"Ed25519":e={name:"Ed25519"},r=t.d?["sign"]:["verify"];break;case"EdDSA":e={name:t.crv},r=t.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":e={name:t.crv},r=t.d?["deriveBits"]:[];break;default:throw new d('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new d('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:e,keyUsages:r}}var st=async t=>{var n,i;if(!t.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');let{algorithm:e,keyUsages:r}=rt(t),s=[e,(n=t.ext)!=null?n:!1,(i=t.key_ops)!=null?i:r],o={...t};return delete o.alg,delete o.use,P.subtle.importKey("jwk",o,...s)},ve=st;var Ie=t=>F(t),T,R,We=t=>(t==null?void 0:t[Symbol.toStringTag])==="KeyObject",V=async(t,e,r,s,o=!1)=>{let n=t.get(e);if(n!=null&&n[s])return n[s];let i=await ve({...r,alg:s});return o&&Object.freeze(e),n?n[s]=i:t.set(e,{[s]:i}),i},ot=(t,e)=>{if(We(t)){let r=t.export({format:"jwk"});return delete r.d,delete r.dp,delete r.dq,delete r.p,delete r.q,delete r.qi,r.k?Ie(r.k):(R||(R=new WeakMap),V(R,t,r,e))}return x(t)?t.k?F(t.k):(R||(R=new WeakMap),V(R,t,t,e,!0)):t},it=(t,e)=>{if(We(t)){let r=t.export({format:"jwk"});return r.k?Ie(r.k):(T||(T=new WeakMap),V(T,t,r,e))}return x(t)?t.k?F(t.k):(T||(T=new WeakMap),V(T,t,t,e,!0)):t},me={normalizePublicKey:ot,normalizePrivateKey:it};var K=t=>t==null?void 0:t[Symbol.toStringTag],ge=(t,e,r)=>{var s,o;if(e.use!==void 0&&e.use!=="sig")throw new TypeError("Invalid key for this operation, when present its use must be sig");if(e.key_ops!==void 0&&((o=(s=e.key_ops).includes)==null?void 0:o.call(s,r))!==!0)throw new TypeError(`Invalid key for this operation, when present its key_ops must include ${r}`);if(e.alg!==void 0&&e.alg!==t)throw new TypeError(`Invalid key for this operation, when present its alg must be ${t}`);return!0},nt=(t,e,r,s)=>{if(!(e instanceof Uint8Array)){if(s&&x(e)){if(Ke(e)&&ge(t,e,r))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!fe(e))throw new TypeError(de(t,e,...C,"Uint8Array",s?"JSON Web Key":null));if(e.type!=="secret")throw new TypeError(`${K(e)} instances for symmetric algorithms must be of type "secret"`)}},at=(t,e,r,s)=>{if(s&&x(e))switch(r){case"sign":if(Te(e)&&ge(t,e,r))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"verify":if(Re(e)&&ge(t,e,r))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!fe(e))throw new TypeError(de(t,e,...C,s?"JSON Web Key":null));if(e.type==="secret")throw new TypeError(`${K(e)} instances for asymmetric algorithms must not be of type "secret"`);if(r==="sign"&&e.type==="public")throw new TypeError(`${K(e)} instances for asymmetric algorithm signing must be of type "private"`);if(r==="decrypt"&&e.type==="public")throw new TypeError(`${K(e)} instances for asymmetric algorithm decryption must be of type "private"`);if(e.algorithm&&r==="verify"&&e.type==="private")throw new TypeError(`${K(e)} instances for asymmetric algorithm verifying must be of type "public"`);if(e.algorithm&&r==="encrypt"&&e.type==="private")throw new TypeError(`${K(e)} instances for asymmetric algorithm encryption must be of type "public"`)};function De(t,e,r,s){e.startsWith("HS")||e==="dir"||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?nt(e,r,s,t):at(e,r,s,t)}var Ft=De.bind(void 0,!1),He=De.bind(void 0,!0);function ct(t,e,r,s,o){if(o.crit!==void 0&&(s==null?void 0:s.crit)===void 0)throw new t('"crit" (Critical) Header Parameter MUST be integrity protected');if(!s||s.crit===void 0)return new Set;if(!Array.isArray(s.crit)||s.crit.length===0||s.crit.some(i=>typeof i!="string"||i.length===0))throw new t('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let n;r!==void 0?n=new Map([...Object.entries(r),...e.entries()]):n=e;for(let i of s.crit){if(!n.has(i))throw new d(`Extension Header Parameter "${i}" is not recognized`);if(o[i]===void 0)throw new t(`Extension Header Parameter "${i}" is missing`);if(n.get(i)&&s[i]===void 0)throw new t(`Extension Header Parameter "${i}" MUST be integrity protected`)}return new Set(s.crit)}var ke=ct;function ye(t,e){let r=`SHA-${t.slice(-3)}`;switch(t){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:t.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:e.namedCurve};case"Ed25519":return{name:"Ed25519"};case"EdDSA":return{name:e.name};default:throw new d(`alg ${t} is not supported either by JOSE or your javascript runtime`)}}async function we(t,e,r){if(r==="sign"&&(e=await me.normalizePrivateKey(e,t)),r==="verify"&&(e=await me.normalizePublicKey(e,t)),L(e))return _e(e,t,r),e;if(e instanceof Uint8Array){if(!t.startsWith("HS"))throw new TypeError(ue(e,...C));return P.subtle.importKey("raw",e,{hash:`SHA-${t.slice(-3)}`,name:"HMAC"},!1,[r])}throw new TypeError(ue(e,...C,"Uint8Array","JSON Web Key"))}var E=t=>Math.floor(t.getTime()/1e3);var lt=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,j=t=>{let e=lt.exec(t);if(!e||e[4]&&e[1])throw new TypeError("Invalid time period format");let r=parseFloat(e[2]),s=e[3].toLowerCase(),o;switch(s){case"sec":case"secs":case"second":case"seconds":case"s":o=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":o=Math.round(r*60);break;case"hour":case"hours":case"hr":case"hrs":case"h":o=Math.round(r*3600);break;case"day":case"days":case"d":o=Math.round(r*86400);break;case"week":case"weeks":case"w":o=Math.round(r*604800);break;default:o=Math.round(r*31557600);break}return e[1]==="-"||e[4]==="ago"?-o:o};var pt=async(t,e,r)=>{let s=await we(t,e,"sign");Ce(t,s);let o=await P.subtle.sign(ye(t,s.algorithm),s,r);return new Uint8Array(o)},Oe=pt;var B=class{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,r){if(!this._protectedHeader&&!this._unprotectedHeader)throw new w("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!Pe(this._protectedHeader,this._unprotectedHeader))throw new w("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let s={...this._protectedHeader,...this._unprotectedHeader},o=ke(w,new Map([["b64",!0]]),r==null?void 0:r.crit,this._protectedHeader,s),n=!0;if(o.has("b64")&&(n=this._protectedHeader.b64,typeof n!="boolean"))throw new w('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:i}=s;if(typeof i!="string"||!i)throw new w('JWS "alg" (Algorithm) Header Parameter missing or invalid');He(i,e,"sign");let c=this._payload;n&&(c=y.encode(M(c)));let a;this._protectedHeader?a=y.encode(M(JSON.stringify(this._protectedHeader))):a=y.encode("");let h=xe(a,y.encode("."),c),b=await Oe(i,e,h),g={signature:M(b),payload:""};return n&&(g.payload=W.decode(c)),this._unprotectedHeader&&(g.header=this._unprotectedHeader),this._protectedHeader&&(g.protected=W.decode(a)),g}};var q=class{constructor(e){this._flattened=new B(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,r){let s=await this._flattened.sign(e,r);if(s.payload===void 0)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${s.protected}.${s.payload}.${s.signature}`}};function _(t,e){if(!Number.isFinite(e))throw new TypeError(`Invalid ${t} input`);return e}var z=class{constructor(e={}){if(!k(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return typeof e=="number"?this._payload={...this._payload,nbf:_("setNotBefore",e)}:e instanceof Date?this._payload={...this._payload,nbf:_("setNotBefore",E(e))}:this._payload={...this._payload,nbf:E(new Date)+j(e)},this}setExpirationTime(e){return typeof e=="number"?this._payload={...this._payload,exp:_("setExpirationTime",e)}:e instanceof Date?this._payload={...this._payload,exp:_("setExpirationTime",E(e))}:this._payload={...this._payload,exp:E(new Date)+j(e)},this}setIssuedAt(e){return typeof e=="undefined"?this._payload={...this._payload,iat:E(new Date)}:e instanceof Date?this._payload={...this._payload,iat:_("setIssuedAt",E(e))}:typeof e=="string"?this._payload={...this._payload,iat:_("setIssuedAt",E(new Date)+j(e))}:this._payload={...this._payload,iat:_("setIssuedAt",e)},this}};var O=class extends z{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,r){var o;let s=new q(y.encode(JSON.stringify(this._payload)));if(s.setProtectedHeader(this._protectedHeader),Array.isArray((o=this._protectedHeader)==null?void 0:o.crit)&&this._protectedHeader.crit.includes("b64")&&this._protectedHeader.b64===!1)throw new D("JWTs MUST NOT use unencoded payload");return s.sign(e,r)}};function ht(t){let e=t.match(/.{1,2}/g);if(!e)throw new Error("Invalid hex string");return new Uint8Array(e.map(r=>parseInt(r,16)))}async function Ge(t){let[e,r]=t.split(":");if(!e||!r)throw new Error('Invalid Ghost API Key format. Expected "id:secret"');let s=ht(r);return await new O({aud:"/admin/"}).setProtectedHeader({alg:"HS256",typ:"JWT",kid:e}).setIssuedAt().setExpirationTime("5m").sign(s)}var X=class{constructor(e){p(this,"plugin");this.plugin=e}get baseUrl(){return`${this.plugin.settings.siteUrl}/ghost/api/admin`}async getHeaders(){return{Authorization:`Ghost ${await Ge(this.plugin.settings.adminApiKey)}`,"Content-Type":"application/json"}}async request(e){let r=await this.getHeaders();try{let s=await(0,Je.requestUrl)({...e,headers:r,throw:!1});return s.status>=400&&this.handleHttpError(s),s}catch(s){throw S(s).toLowerCase().includes("timeout")?new Error("Ghost API request timed out."):s}}handleHttpError(e){let r=`Ghost API Error (${e.status})`;try{let s=e.json;s&&s.errors&&s.errors.length>0&&(r=s.errors[0].message)}catch(s){}throw new Error(r)}async testConnection(){return!this.plugin.settings.siteUrl||!this.plugin.settings.adminApiKey?!1:(await this.request({url:`${this.baseUrl}/site/`,method:"GET"})).status===200}async createPost(e){let s=(await this.request({url:`${this.baseUrl}/posts/?source=html`,method:"POST",body:JSON.stringify({posts:[e]})})).json.posts[0];return{id:s.id,status:s.status,url:s.url,title:s.title}}async updatePost(e,r){let o=(await this.request({url:`${this.baseUrl}/posts/${e}/?source=html`,method:"PUT",body:JSON.stringify({posts:[r]})})).json.posts[0];return{id:o.id,status:o.status,url:o.url,title:o.title}}};var A=require("obsidian");function ut(t){return t.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-")}async function dt(t,e,r){if(r&&r.trim().length>0)return r;let o=(await t.vault.read(e)).match(/^#\s+(.*)$/m);return o?o[1].trim():e.basename}async function G(t,e){let r=t.metadataCache.getFileCache(e),s=(r==null?void 0:r.frontmatter)||{},o=s.ghost||{},n=await dt(t,e,o.title),i=o.slug||ut(n),c=o.tags||s.tags||[];return typeof c=="string"&&(c=[c]),{title:n,slug:i,excerpt:o.excerpt||s.excerpt||"",tags:c.map(a=>({name:a})),feature_image:o.feature_image||null,canonical_url:o.canonical_url||null,visibility:o.visibility||"public",published_at:o.published_at||null,status:o.status||"draft",post_id:o.post_id||null}}async function be(t,e,r,s){await t.fileManager.processFrontMatter(e,o=>{o.ghost||(o.ghost={}),o.ghost.post_id=r,o.ghost.status=s})}async function Ee(t,e){let r=[],s=await t.app.vault.read(e),o=await G(t.app,e);o.title&&o.title.trim().length>0?r.push({id:"title",label:"Resolved Title",status:"ok",details:`Title: "${o.title}"`}):r.push({id:"title",label:"Resolved Title",status:"fail",details:"No title could be found in frontmatter, H1, or filename."}),s.match(/^#\s+(.*)$/m)?r.push({id:"h1",label:"H1 Header",status:"ok",details:"Found top-level H1 header."}):r.push({id:"h1",label:"H1 Header",status:"fail",details:"No H1 (# Header) found in content. Ghost usually expects an H1."});let i=100,c=s.trim().length;c>=i?r.push({id:"length",label:"Content Length",status:"ok",details:`${c} characters.`}):r.push({id:"length",label:"Content Length",status:"warn",details:`Note is very short (${c} chars). Minimal recommended is ${i}.`}),o.feature_image&&(/^(https?:\/\/)[^\s$.?#].[^\s]*$/i.test(o.feature_image)?r.push({id:"image",label:"Feature Image",status:"ok",details:"Valid URL format."}):r.push({id:"image",label:"Feature Image",status:"warn",details:"URL format seems invalid (must start with http/https)."})),o.excerpt&&o.excerpt.trim().length>0?r.push({id:"excerpt",label:"Excerpt",status:"ok"}):r.push({id:"excerpt",label:"Excerpt",status:"warn",details:"No excerpt provided. Ghost will auto-generate one."});let a=/\[.*?\]\((.*?)\)/g,h,b=!1;for(;(h=a.exec(s))!==null;){let u=h[1];if(u.includes("http//")||u.includes("https//")||!u.startsWith("http")&&!u.startsWith("#")&&!u.startsWith("/")){b=!0;break}}b?r.push({id:"links",label:"Link Validation",status:"warn",details:'Some links look suspicious (e.g. "http//" typo or broken protocol).'}):r.push({id:"links",label:"Link Validation",status:"ok",details:"Standard links check passed."}),(!t.settings.siteUrl||!t.settings.adminApiKey)&&r.push({id:"config",label:"Plugin Config",status:"fail",details:"Ghost URL or API Key missing in settings."});let g=!r.some(u=>u.status==="fail"),Ne=r.filter(u=>u.status==="fail").map(u=>u.details||u.label);return{isValid:g,items:r,errors:Ne}}async function Ue(t,e){let r=await Ee(t,e);return{isValid:r.isValid,errors:r.errors}}var J=require("obsidian");var Y=class extends J.Modal{constructor(r,s){super(r);p(this,"result","");p(this,"onSubmit");this.onSubmit=s}onOpen(){let r=this.contentEl;r.createEl("h2",{text:"Schedule Post"});let s="";new J.Setting(r).setName("Publication Date & Time").setDesc("Select when you want this post to be published.").addText(o=>{o.inputEl.type="datetime-local",o.onChange(n=>{s=n})}),new J.Setting(r).addButton(o=>o.setButtonText("Schedule").setCta().onClick(()=>{if(!s)return;let n=new Date(s);this.close(),this.onSubmit(n.toISOString())}))}onClose(){this.contentEl.empty()}};var Z=class{constructor(e){p(this,"plugin");this.plugin=e}register(){let e=this.plugin;e.addCommand({id:"ghost-publish-draft",name:"Publish to Ghost as Draft",callback:()=>this.handlePublish("draft")}),e.addCommand({id:"ghost-publish-now",name:"Publish to Ghost Now",callback:()=>this.handlePublish("published")}),e.addCommand({id:"ghost-publish-schedule",name:"Schedule Ghost Post",callback:()=>{new Y(this.plugin.app,r=>{this.handlePublish("scheduled",r)}).open()}}),e.addCommand({id:"ghost-update-post",name:"Update existing Ghost post",callback:()=>this.handleUpdate()}),e.addCommand({id:"ghost-open-checks",name:"Show pre-publish checks panel",callback:()=>this.plugin.activateView()})}async handlePublish(e,r){let s=this.plugin.app.workspace.getActiveFile();if(!s)return;let o=await Ue(this.plugin,s);if(!o.isValid){this.showActionableError(o.errors.join(". "));return}try{let n=await this.plugin.app.vault.read(s),i=await G(this.plugin.app,s),c=n.replace(/^---[\s\S]*?---/,"").trim(),a={title:i.title,slug:i.slug,status:e,excerpt:i.excerpt,tags:i.tags,feature_image:i.feature_image,canonical_url:i.canonical_url,visibility:i.visibility,html:`<div class="kg-card kg-markdown-card">${c}</div>`};e==="scheduled"&&r&&(a.published_at=r),new A.Notice(`Publishing to Ghost as ${e}...`);let h;i.post_id?h=await this.plugin.ghostClient.updatePost(i.post_id,a):h=await this.plugin.ghostClient.createPost(a),await be(this.plugin.app,s,h.id,h.status),new A.Notice(`Success: Post is now ${h.status}`)}catch(n){this.showActionableError(S(n))}}async handleUpdate(){let e=this.plugin.app.workspace.getActiveFile();if(!e)return;let r=await G(this.plugin.app,e);if(!r.post_id){new A.Notice('Error: This note has no ghost.post_id. Use "Publish" commands first.');return}try{let o=(await this.plugin.app.vault.read(e)).replace(/^---[\s\S]*?---/,"").trim(),n={title:r.title,slug:r.slug,status:r.status,excerpt:r.excerpt,tags:r.tags,feature_image:r.feature_image,canonical_url:r.canonical_url,visibility:r.visibility,published_at:r.published_at,html:`<div class="kg-card kg-markdown-card">${o}</div>`};new A.Notice("Updating Ghost post...");let i=await this.plugin.ghostClient.updatePost(r.post_id,n);await be(this.plugin.app,e,i.id,i.status),new A.Notice(`Successfully updated: ${i.title}`)}catch(s){this.showActionableError(S(s))}}showActionableError(e){let r=e;e.includes("401")||e.includes("403")?r="Authentication Failed: Please check if your Admin API Key is valid and has correct permissions.":e.includes("404")?r="Not Found: Check if your Ghost Site URL is correct or if the Post ID still exists.":(e.includes("ENOTFOUND")||e.includes("fetch"))&&(r="Network Error: Could not reach the Ghost server. Check your URL and internet connection."),new A.Notice(`Ghost Publisher Error: ${r}`,8e3),console.error("Ghost Publisher Detailed Error:",e)}};var v=require("obsidian");var I="ghost-checks-view",U=class extends v.ItemView{constructor(r,s){super(r);p(this,"plugin");this.plugin=s}getViewType(){return I}getDisplayText(){return"Ghost Publisher Checks"}getIcon(){return"clipboard-check"}async onOpen(){this.update()}async update(){let r=this.containerEl.children[1];r.empty(),r.addClass("ghost-checks-container");let s=this.plugin.app.workspace.getActiveFile(),o=r.createDiv({cls:"ghost-checks-header"});o.createEl("h4",{text:"Pre-publish Checks"});let n=o.createEl("button",{text:"Re-run checks",cls:"mod-cta"});if(n.onclick=()=>this.update(),!s){r.createEl("p",{text:"Open a markdown file to see checks.",cls:"ghost-checks-empty"});return}r.createEl("p",{text:`File: ${s.name}`,cls:"ghost-checks-file-info"});let i=await Ee(this.plugin,s),c=r.createDiv({cls:"ghost-checks-list"});i.items.forEach(a=>{let h=c.createDiv({cls:`ghost-check-item status-${a.status}`}),b=h.createSpan({cls:"ghost-check-icon"});a.status==="ok"?(0,v.setIcon)(b,"check-circle"):a.status==="warn"?(0,v.setIcon)(b,"alert-triangle"):a.status==="fail"&&(0,v.setIcon)(b,"x-circle");let g=h.createDiv({cls:"ghost-check-text"});g.createDiv({cls:"ghost-check-label",text:a.label}),a.details&&g.createDiv({cls:"ghost-check-details",text:a.details})}),i.isValid?r.createDiv({cls:"ghost-checks-summary success",text:"All critical checks passed! Ready to publish."}):r.createDiv({cls:"ghost-checks-summary failure",text:"Fix critical issues before publishing."})}};var Q=class extends $e.Plugin{constructor(){super(...arguments);p(this,"settings");p(this,"ghostClient")}async onload(){await this.loadSettings(),this.ghostClient=new X(this),this.registerView(I,s=>new U(s,this)),this.addSettingTab(new N(this.app,this)),new Z(this).register(),this.registerEvent(this.app.workspace.on("file-open",()=>{this.updateChecksView()})),console.log("Ghost Publisher loaded")}onunload(){console.log("Ghost Publisher unloaded")}async loadSettings(){this.settings=Object.assign({},Se,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}updateChecksView(){this.app.workspace.getLeavesOfType(I).forEach(s=>{let o=s.view;o instanceof U&&o.update()})}async activateView(){let{workspace:r}=this.app,s=null,o=r.getLeavesOfType(I);o.length>0?s=o[0]:(s=r.getRightLeaf(!1),s&&await s.setViewState({type:I,active:!0})),s&&r.revealLeaf(s)}};
